<% environment.context_class.instance_eval { include ImagesHelper } %>

$j(document).ready(function () {
    $j('[data-role="seek-git-jstree-container"]').each(function () {
        var container = $j(this);
        var element = $j('[data-role="seek-git-jstree"]', container);
        var json = JSON.parse($j('script[data-role="seek-git-jstree-data"]', container).html());

        element.jstree({
            'plugins': ['wholerow', 'checkbox', 'types', 'conditionalselect'],
            'checkbox': {
                'three_state': false
            },
            'types' : {
                'root': {
                    'icon': '<%= asset_path(icon_filename_for_key('git_repository')) %>',
                    'a_attr': { 'class': 'git-jstree-root' }
                },
                'tree' : {
                    'icon': '<%= asset_path(icon_filename_for_key('organise')) %>',
                    'a_attr': { 'class': 'git-jstree-tree' }
                },
                'blob': {
                    'icon': '<%= asset_path(icon_filename_for_key('markup')) %>',
                    'a_attr': { 'class': 'git-jstree-blob' }
                }
            },
            'conditionalselect' : function (node, event) {
                if (element.hasClass('only-select-blobs')) {
                    return node.type === 'blob'
                }
                return true;
            },
            'core': {
                'check_callback': true,
                'force_text': true,
                'multiple': false,
                'dblclick_toggle': true,
                'data': json
            }
        })
    });

    $j('[data-role="seek-git-browser-modal-btn"]').click(function () {
        var modal = $j(this).parents('.modal');
        var input = modal.data('targetInput');
        var jstree = $j('.jstree', modal).jstree(true);
        input.val(jstree.get_selected());
        modal.modal('hide');

        return false;
    });

    $j('[data-role="seek-git-path-input"]').each(function () {
        var input = $j(this);
        var modal = $j(input.data('modal'));
        var jstreeElement = $j('.jstree', modal);
        var selectTrees = input.data('select-trees');
        input.click(function () {
            if (!selectTrees) {
                jstreeElement.addClass('only-select-blobs');
            }
            else {
                jstreeElement.removeClass('only-select-blobs');
            }
            jstreeElement.jstree(true).refresh(true, true);

            if (input.val()) {
              jstreeElement.jstree(true).select_node(input.val());
            }
            modal.modal();
            modal.modal('show');
            modal.data('targetInput', input);

            return false;
        });

        input.blur(function () {
            modal.modal('hide');
            modal.data('targetInput', null);

            return true;
        });
    });

});