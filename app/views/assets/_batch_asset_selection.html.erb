<%
  publishing ||= false
  show_hide_blocked ||= false
  show_permissions ||= false
  show_managers ||= false
  blocked_selector ||= ''
-%>

<div class="batch-selection-scope tabpanel">
  <%= render partial: 'assets/batch_asset_selection_buttons', locals: {
    text: "your items",
    select_deselect_all: true,
    collapse_expand: true,
    show_hide_permissions: show_permissions
  } %>

  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active">
      <a href="#sorted_by_type" aria-controls="sorted_by_type" role="tab" data-toggle="tab">
        Sort by type
      </a>
    </li>
    <li role="presentation">
      <a href="#sorted_by_isa" aria-controls="sorted_by_isa" role="tab" data-toggle="tab">
        Sort by ISA
      </a>
    </li>
  </ul>

  <div class="tab-content collapse-scope">
    <div id="sorted_by_type" role="tabpanel" class="tab-pane active">
      <% @assets.sort_by { |k, v| v.first.class.name }.each do |type, items| %>
        <div id="<%= items.first.class.table_name %>" class="batch-selection-scope">
          <h2><%= render partial: 'assets/isa-tree-toggle' -%> <%= text_for_resource items.first %>(s)</h2>
          <div class="collapse-scope">
            <%= render partial: 'assets/batch_asset_selection_buttons', locals: {
              text: (text_for_resource items.first).downcase.pluralize,
              select_deselect_all: true
            } %>
            <% items.each do |item| %>
              <%= render partial: 'assets/asset_checkbox_row',
                         object: item,
                         locals: { html_classes: 'publishing_options',
                                   block_published: publishing,
                                   show_permissions: show_permissions,
                                   show_managers: show_managers
                         } -%>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div id="sorted_by_isa" role="tabpanel" class="tab-pane">
      <% unless @assets_not_in_isa.empty? %>
        <div id="items_not_in_isa" class="batch-selection-scope">
          <h2><%= render partial: 'assets/isa-tree-toggle' -%> Items not in ISA</h2>
          <div class="collapse-scope">
            <%= render partial: 'assets/batch_asset_selection_buttons', locals: {
              text: "items not in ISA",
              select_deselect_all: true
            } %>
            <% @assets_not_in_isa.each do |item| %>
              <%= render partial: 'assets/asset_checkbox_row',
                         object: item,
                         locals: { html_classes: "publishing_options",
                                   block_published: publishing,
                                   show_permissions: show_permissions,
                                   show_managers: show_managers
                         } -%>
            <% end %>
          </div>
          <br/>
        </div>
      <% end %>

      <br/>

      <% unless @investigations.empty? %>
        <div id="items_in_isa" class="batch-selection-scope">
          <h2><%= render partial: 'assets/isa-tree-toggle'-%> Items in ISA</h2>
          <div class="collapse-scope">
            <%= render partial: 'assets/batch_asset_selection_buttons', locals: {
              text: "items in ISA",
              blocked_selector: blocked_selector,
              select_deselect_all: true,
              collapse_expand: true,
              show_hide_blocked: show_hide_blocked
            } %>
            <div id="investigation_list">
              <% @investigations.each do |inv| %>
                <% collection = inv.assays.map(&:study).map(&:investigation).flatten.uniq %>
                <% collection = inv.studies.map(&:investigation).flatten.uniq if collection.empty? %>
                <% collection = [inv] if collection.empty?%>
                <%= render partial: 'assets/isa_tree_preview',
                           locals: { publishing: publishing,
                                     show_permissions: show_permissions,
                                     show_managers: show_managers
                           },
                           collection: collection %>
              <% end %>
            </div>
            <br/>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script type="text/javascript">
    $j(document).ready(function () {
        BatchAssetSelection.hideBlocked('<%= blocked_selector -%>');
    })
</script>
