<%# This partial is expecting 3 parameters to be defined: -%>
<%# - resource_type - type of resource for which the attributions form is displayed (required because various types of resources have different requirements for attributions) -%>
<%# - existing_attributions - collection of existing attributions for the current resource (this should be collection of resources - NOT collection of records of Attribution class) -%>
<%# - attribution_suggestions - JSON array of data to be used to generate autocompleter suggestions -%>


<!-- Attributions -->

<%# this hidden input will submit all permission data with the form -%>
<%= hidden_field_tag "attributions", "" -%>

<% case resource_type.downcase; when "sop" -%>
  <% resource_type_attributed_to_types = t('sop').pluralize -%>
  <% when "model" -%>
  <% resource_type_attributed_to_types = t('model').pluralize -%>
  <% when "datafile" -%>
  <% resource_type_attributed_to_types = t('data_file').pluralize -%>
  <% when "presentation" -%>
  <% resource_type_attributed_to_types = t('presentation').pluralize -%>
<% else -%>
  <% resource_type_attributed_to_types = "THIS MUST BE A NEW TYPE OF RESOURCE FOR WHICH ATTRIBUTIONS ARE INTRODUCED - ADD IT HERE" -%>
<% end -%>

<% resource_type_text = text_for_resource(resource_type) -%>

<%= folding_panel('Attributions', existing_attributions.blank?, :body_options => {:id => 'attributions_fold_content'},
                  :help_text => "Here you attribute this #{resource_type_text} to other #{resource_type_attributed_to_types}.") do %>
    <p>
      If this <%= resource_type_text %> is based on any existing <%= resource_type_attributed_to_types -%>, please list them below
    </p>

    <div class="box_editing">
      <p class="pale_text">
        So far you have specified the following attributions:
      </p>
      <p id="attributed_to_list" class="box_editing_inner">
        <span class="none_text" id="attributed_to_text">Loading...</span>
      </p>

      <p>
        Please type titles of <%= resource_type_attributed_to_types -%> into the box below - suggestions will be displayed as you type.
        Select resources that you want to attribute to.
      </p>

      <%= objects_input('attribution-typeahead', [], :typeahead => {:query_url => typeahead_sops_path + '?query=%QUERY'}) -%>
    </div>

<% end %>

<script type="text/javascript">
  // recreate internal store of attributions..
  var attributions = <%= existing_attributions.map { |a| {type: a.class.name, id: a.id, name: h(a.title), contributor: a.contributor.person.name }}.to_json.html_safe -%>
  // ..and update the page to make existing attributions visible
  updateAttributionSettings();
</script>
