<%= javascript_include_tag "jquery-1.5.1.min.js", "cytoscape.js-2.0.2/cytoscape.js", "cytoscape.js-2.0.2/jquery.cxtmenu.min",
                           "cytoscape.js-2.0.2/jquery.cytoscape-edgehandles.min", "cytoscape.js-2.0.2/jquery.cytoscape-panzoom.min" %>

<div id="cy" style="float:center;position:inherit; width: 100%; height: 400px; background-color: #fff0f5;"></div>

<script type="text/javascript">
    jQuery.noConflict();
    var $j = jQuery;

    $j('#cy').cytoscape({
        layout: {
          name: 'breadthfirst'
        },

        style: cytoscape.stylesheet()
                .selector('node')
                .css({
                    'shape': 'roundrectangle',
                    'border-color': 'data(borderColor)',
                    'border-width': 2,
                    'das': 'mapData(weight, 40, 80, 20, 60)',
                    'content': 'data(name)',
                    'text-valign': 'center',
                    'text-outline-width': 1,
                    'text-outline-color': 'data(faveColor)',
                    'background-color': 'data(faveColor)',
                    'color': 'black',
                    'width':150,
                    'height':30,
                    'font-size':10
                })


                .selector('edge')
                .css({
                    'width': 1.5,
                    'target-arrow-shape': 'triangle',
                    'line-color': 'data(faveColor)',
                    'source-arrow-color': 'data(faveColor)',
                    'target-arrow-color': 'data(faveColor)'
                })
                .selector('.faded')
                .css({
                    'opacity': 0.25,
                    'text-opacity': 0
                }),

        elements: <%= buiding_elements(item_graph.study, true, item_graph).to_json.html_safe %>,

        ready: function(){
            cy = this;

            //Centre on all elements in the graph.
            cy.center();

            nodes = cy.$('node');
            edges = cy.$('edge');

            nodes.one('click', function(e){
                var node = e.cyTarget;
                nodes.css('opacity',0.3);
                nodes.css('width',150);
                nodes.css('height',30);
                edges.css('opacity',0.2);
                node.css('opacity',1);
                edges.each(function(i, edge){
                    var source = edge.source();
                    var target =edge.target();
                    if (source.id() == node.id()){
                        edge.css('opacity',1);
                        target.css('opacity',1);
                    }
                    if (target.id() == node.id()){
                        edge.css('opacity',1);
                        source.css('opacity',1);
                    }
                });

                node.animate({
                    css: { width:200, height:40 }
                }, {
                    duration: 300
                });


            });

            nodes.one('mouseover', function(e){
                var node = e.cyTarget;

                //node.css('background-color','red');

            });

            nodes.one('mouseout', function(e){
                //var node = e.cyTarget;
                //node.css('background-color','yellow');

            });


        }
    });

</script>