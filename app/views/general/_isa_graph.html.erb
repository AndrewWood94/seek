<%
  options ||= { depth: 1, parent_depth: 1, include_self: true }
  graph_hash = Seek::IsaGraphGenerator.new(root_item).generate(options.merge(parent_depth: nil))
  tree_hash = Seek::IsaGraphGenerator.new(root_item).generate(options.merge(parent_depth: nil))
  elements = cytoscape_elements(graph_hash)

  #show only current node and connected nodes
  #if set force_max_node to true, show only max_node_number if (current node + connected nodes) is bigger then max_node_number
  # reduced_elements = reduced_elements(elements, max_node_number, force_max_node, root_item)
%>

<div class="row">
  <div class="col-sm-12 hidden-xs">
    <div id="isa-graph" class="panel panel-default">
      <a href="#" id="exit-fullscreen-btn" aria-label="Close">&times;</a>
      <div id="node_info"></div>
      <div class="isa-footer">
        <div id="isa-view-controls">
          <div class="btn-group" data-toggle="buttons">
            <label class="btn btn-default btn-xs active" id="isa-tree-view-btn" >
              <input type="radio" name="options" autocomplete="off"> Tree
            </label>
            <label class="btn btn-default btn-xs" id="isa-split-view-btn">
              <input type="radio" name="options" autocomplete="off" checked> Split
            </label>
            <label class="btn btn-default btn-xs" id="isa-graph-view-btn" >
              <input type="radio" name="options" autocomplete="off"> Graph
            </label>
          </div>
        </div>
        <br/>
        <button class="btn btn-default btn-xs" id="toggle-fullscreen-btn">
          <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
          Toggle fullscreen
        </button>
      </div>
      <div class="isa-wrapper">
        <div id="cy"></div>
        <%= render partial: 'general/jstree', locals: { hash: tree_hash } %>
      </div>
    </div>

    <span id="ruler" style="visibility: hidden"></span>
  </div>
</div>

<script type="text/javascript">
    var isaGraph = $j('.isa_graph')[0];
    var elements = <%= elements.to_json.html_safe %>;
    var originElementId = '<%= node_id(root_item) -%>';

    if (elements.error === 'error') {
        isaGraph.innerHTML = "<div class='none_text'>Currently unable to display the graph for this item</div>";
        isaGraph.style['text-align'] = 'center';
    }
    else if (!isCanvasSupportBrowser() || !isIEVersionSupported(5)) {
        isaGraph.innerHTML = "<div class='none_text'>Unable to display the graph for this browser version. Please upgrade your browser.</div>";
        isaGraph.style['text-align'] = 'center';
    } else {
        ISA.decodeHTMLForElements(elements);
        ISA.drawGraph(elements, originElementId);
    }

    $j(document).ready(function () {
        $j('#toggle-isa-sidebar-btn').click(function () {
            $j('#jstree').toggle();
            cy.resize();
            return false;
        });

        $j('#isa-split-view-btn').click(function () {
            $j(this).button('toggle');
            $j('#cy').show();
            $j('#jstree').show();
            $j('#node_info').show();
            $j('#jstree').css('width', '300px');
            cy.resize();
            return false;
        });

        $j('#isa-graph-view-btn').click(function () {
            $j(this).button('toggle');
            $j('#cy').show();
            $j('#node_info').show();
            $j('#jstree').hide();
            cy.resize();
        });

        $j('#isa-tree-view-btn').click(function () {
            $j(this).button('toggle');
            $j('#cy').hide();
            $j('#node_info').hide();
            $j('#jstree').show();
            $j('#jstree').css('width', '100%');
        });

        $j('#exit-fullscreen-btn').click(function () {
            ISA.fullscreen(false);
            return false;
        });

        $j('#toggle-fullscreen-btn').click(function () {
            ISA.fullscreen();
            return false;
        });

        $j(document).keyup(function(e) {
            if (e.keyCode == 27) { // Escape key
                ISA.fullscreen(false);
            }
        });

        $j('#cy').hide();
        $j('#jstree').show();
        $j('#node_info').hide();
        $j('#jstree').css('width', '100%');
    });
</script>
