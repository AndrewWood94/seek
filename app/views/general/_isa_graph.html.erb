<%= javascript_include_tag "jquery-1.5.1.min.js", "cytoscape.js-2.0.2/cytoscape.js", "cytoscape.js-2.0.2/jquery.cxtmenu.js",
                           "cytoscape.js-2.0.2/jquery.cytoscape-edgehandles.js", "cytoscape.js-2.0.2/jquery.cytoscape-panzoom.js",
                           "isa_graph.js" %>
<%= stylesheet_link_tag "cytoscape.js-2.0.2/jquery.cytoscape-panzoom.css", "cytoscape.js-2.0.2/css/font-awesome.css", "isa_graph.css" %>

<%
  current_item ||= nil
  deep ||= true
%>

<div class="yui-u first isa_graph">
    <div id="cy"></div>
</div>
<div class="yui-u node_info" id="node_info">
</div>

<script type="text/javascript">
    jQuery.noConflict();
    var $j = jQuery;

    var default_node_width = 200;
    var default_node_height = 40;
    var default_font_size = 12;

    $j('#cy').cytoscape({
        layout: {
          name: 'breadthfirst'
        },

        showOverlay: false,

        style: cytoscape.stylesheet()
                .selector('node')
                .css({
                    'shape': 'roundrectangle',
                    'border-color': 'data(borderColor)',
                    'border-width': 2,
                    'das': 'mapData(weight, 40, 80, 20, 60)',
                    'content': 'data(name)',
                    'text-valign': 'center',
                    'text-outline-width': 1,
                    'text-outline-color': 'data(faveColor)',
                    'background-color': 'data(faveColor)',
                    'color': '#323232',
                    'width':default_node_width,
                    'height':default_node_height,
                    'font-size':default_font_size
                })

                .selector('edge')
                .css({
                    'width': 1.5,
                    'target-arrow-shape': 'triangle',
                    'line-color': 'data(faveColor)',
                    'source-arrow-color': 'data(faveColor)',
                    'target-arrow-color': 'data(faveColor)'
                }),

        elements: <%= cytoscape_elements(root_item, current_item, deep).to_json.html_safe %>,

        ready: function(){
            cy = this;

            cy.reset();
            cy.center();
        }
    });

    $j(function(){
        $j('#cy').cytoscapePanzoom();

        var nodes = cy.$('node');
        nodes.on('click', function(e){
            var node = e.cyTarget;
            displayNodeInfo(node);
        });

        nodes.on('mouseover', function(e){
            var node = e.cyTarget;
            animateNode(node);
        });

        //animate the current asset node
        var asset_type =  '<%= controller_name.singularize.camelize %>';
        var asset_id = '<%= params[:id] %>';
        var asset_node_id = asset_type + '_' + asset_id;
        var asset_node = cy.nodes('[id=\''+ asset_node_id +'\']')[0];
        animateNode(asset_node);
    });
</script>
