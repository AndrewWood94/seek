<% if options.any? %>
  <%
    start_date = nil
    end_date = nil
    # User supplied options (not one of the presets), should not appear as options in the dropdown menu.
    option_pairs = options.select { |o| o.data[:preset] }.map { |option| ["#{option.label} (#{option.count})", option.value] } + [['Custom range', 'custom']]
    active_options = options.select(&:active?)
    if active_options.any?
      selected_preset = active_options.detect { |o| o.data[:preset] }
      if selected_preset
        selected_option_value = selected_preset.value
      elsif active_options.length == 1
        date_range = active_options.first.data[:date_range]
        start_date = date_range.begin.iso8601
        end_date = date_range.end.iso8601 unless date_range.end.is_a?(Date::Infinity)
        selected_option_value = 'custom'
      else # If the user has crafted some complex query with multiple ranges, we can't hope to fit it into the date range form.
        option_pairs += [['Other', 'other']]
        selected_option_value = 'other'
      end
    else
      selected_option_value = nil
    end

    apply_url = url_for({ page: nil, filter: with_filter(key, '_date_', replace: true) })
    remove_url = url_for({ page: nil, filter: without_filter(key) })
  %>

  <%= content_tag(:div, class: 'filter-category', data: { role: 'seek-date-filter',
                                                          'apply-filter-url' => apply_url,
                                                          'remove-filter-url' => remove_url  }) do %>
    <div class="filter-category-title"><%= key.to_s.humanize %></div>
    <%= select_tag(nil,
                   options_for_select(option_pairs, selected_option_value),
                   data: { role: 'seek-date-filter-select' },
                   autocomplete: 'off',
                   include_blank: 'Any time',
                   class: 'form-control filter-dropdown')
    %>
    <%= content_tag(:div, { class: 'filter-date-range-wrapper', style: 'display: none;', data: { role: 'seek-date-filter-custom' } }) do %>
      <%= text_field_tag(nil, start_date,
                         data: { role: 'seek-date-filter-period-start' },
                         placeholder: 'Start',
                         autocomplete: 'off',
                         class: 'filter-date-range-field') -%>
      <%= text_field_tag(nil, end_date,
                         data: { role: 'seek-date-filter-period-end' },
                         placeholder: 'End (optional)',
                         autocomplete: 'off',
                         class: 'filter-date-range-field') -%>
      <%= link_to('Go', '#', data: { role: 'seek-date-filter-btn' }, class: 'filter-date-range-button') %>
    <% end %>
  <% end %>
<% end %>
