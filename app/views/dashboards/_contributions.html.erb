<div class="form-group pull-right">
  <select class="form-control" autocomplete="off" id="contributions-range-select">
    <option value="<%= 1.months.ago.strftime('%Y-%m-%d') -%>">last month</option>
    <option value="<%= 3.months.ago.strftime('%Y-%m-%d') -%>">last 3 months</option>
    <option value="<%= 12.months.ago.strftime('%Y-%m-%d') -%>" selected="selected">last 12 months</option>
    <option value="<%= @project.created_at.strftime('%Y-%m-%d') -%>">since project began</option>
  </select>
</div>
<div class="form-group pull-right">
  <select class="form-control" autocomplete="off" id="contributions-interval-select">
    <option value="year">by year</option>
    <option value="month" selected="selected">by month</option>
    <option value="day">by day</option>
  </select>
</div>

<canvas id="contributions-canvas"></canvas>

<p class="help-block">
  Mouse over a bar to see the breakdown of contributions for that month.
  Clicking on a type in the legend will hide it from the chart.
</p>

<script>
    var ctx = document.getElementById('contributions-canvas').getContext('2d');
    var contributionChart = new Chart(ctx, {
        type: 'bar',
        data: {},
        options: {
            legend: {
                position: 'right'
            },
            title: {
                display: false,
                text: 'Contributions'
            },
            tooltips: {
                mode: 'index',
                filter: function (x) { return x.yLabel > 0 }, // Hide asset types with 0 contributions in that month
                intersect: false
            },
            responsive: true,
            scales: {
                xAxes: [{
                    stacked: true,
                }],
                yAxes: [{
                    ticks: { // This whole block is just to avoid and protoype.js bug that breaks the whole chart
                        beginAtZero:true,
                        userCallback: function(label, index) {
                            if (Math.floor(label) === label) {
                                return label;
                            }
                        }
                    },
                    stacked: true
                }]
            }
        }
    });

    function getContributionStats() {
        var startDate = $j('#contributions-range-select').val();
        var interval = $j('#contributions-interval-select').val();

        $j('#contributions-canvas').spinner('add');

        $j.ajax({ url: '<%= contributions_project_dashboard_path(@project) -%>',
            data: { start_date: startDate, interval: interval },
            success: function (resp) {
                contributionChart.data = resp;
                contributionChart.update();
            },
            error: function () {
                $j('#contributions-canvas').html('<div class="alert alert-danger">An error occurred whilst fetching your query.</div>');
            },
            complete: function () {
                $j('#contributions-canvas').spinner('remove');
            }
        });
    }

    $j('#contributions-range-select').change(getContributionStats);
    $j('#contributions-interval-select').change(getContributionStats);

    getContributionStats();
</script>