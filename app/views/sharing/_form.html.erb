<%
  object ||= nil
  set_parameters_for_sharing_form object
  @resource.policy.access_type ||= Seek::Config.default_all_visitors_access_type
%>

<%= folding_panel('Sharing', false, :id => 'sharing_form', :body_options => {:id => 'creator_fold_content'},
                  :help_text => "Here you can specify who can <b>see</b>#{', <b>download</b>' if @resource.is_downloadable?} and <b>edit</b> this #{@resource_type}.") do %>
    <div class="alert alert-info">
      <p>
        Here you can specify who can <b>view</b> the summary of<% if @resource.is_downloadable? %>, <b>get</b> access to the content of,<% end %> and <b>edit</b> the <%= @resource_type -%>.
        <%= link_to_function(("More info " + expand_image).html_safe, visual_effect(:toggle_blind, "more_sharing_info", :duration => 0.3)) -%>
      </p>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered permissions-table" id="permissions-table">
        <thead>
        <tr>
          <th class="name-column"></th>
          <th class="permission-column no-access">No Access</th>
          <th class="permission-column">View</th>
          <th class="permission-column">Download</th>
          <th class="permission-column">Edit</th>
          <th class="permission-column">Manage</th>
          <th class="actions-column"></th>
        </tr>
        </thead>
        <tbody>
        <tr class="permission-row mandatory">
          <td class="name-cell">Public</td>
          <td class="privilege-cell" v-bind:class="getClass(accessType, publicAccessType, false)" v-for="accessType in accessTypes" v-on:click="setPublicAccessType(accessType.value)">
            <input autocomplete="off" type="radio" name="policy[access_type]" v-model="publicAccessType" v-bind:value="accessType.value"/>
          </td>
          <td class="actions-cell"></td>
        </tr>
        <tr class="permission-row" v-for="(permission, index) in permissions">
          <td class="name-cell">
            ({{ permission.contributor_type }}) {{ permission.title }}
            <input type="hidden" v-bind:name="'policy[permissions][' + index +'][contributor_type]'" v-model="permission.contributor_type"/>
            <input type="hidden" v-bind:name="'policy[permissions][' + index +'][contributor_id]'" v-model="permission.contributor_id"/>
          </td>
          <td class="privilege-cell" v-bind:class="getClass(accessType, permission.access_type, true)" v-for="accessType in accessTypes" v-on:click="setAccessType(index, accessType.value)">
            <input autocomplete="off" type="radio" v-bind:name="'policy[permissions][' + index +'][access_type]'" v-model="permission.access_type" v-bind:value="accessType.value"/>
          </td>
          <td class="actions-cell">
            <a v-if="!permission.mandatory" v-on:click="deletePermission(index)" class="btn btn-xs btn-danger remove-permission" title="Remove this permission">
              <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
            </a>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <%= button_link_to('Share with a person', 'add', '#', id: 'add-person-permission-button') %>
    <%= button_link_to('Share with a project/institution', 'add', '#', id: 'add-project-permission-button') %>

    <%= modal(id: 'add-person-permission-modal', size: 'm') do %>
        <%= modal_header('Share with people') %>
        <%= modal_body do %>
            <div class="form-group">
              <label>The following people...</label>
              <%= objects_input('permission-people-ids', [], typeahead: { values: Person.all.map { |p| { id: p.id, name: p.name, hint: p.email } } }) -%>
              <p class="help-block">Start typing a person's name and select from the list that appears. You can select multiple people.</p>
            </div>
            <div class="form-group">
              <label>can...</label>
              <%= select_tag('permission-people-access-type', policy_selection_options(nil, nil, Policy::ACCESSIBLE), class: 'form-control') -%>
            </div>
        <% end %>
        <%= modal_footer do %>
            <%= link_to('Add', '#', id: 'permission-people-confirm', class: 'btn btn-primary pull-right', 'data-dismiss' => 'modal') %>
        <% end %>
    <% end %>

    <%= modal(id: 'add-project-permission-modal', size: 'm') do %>
        <%= modal_header('Share with a project and/or institution') %>
        <%= modal_body do %>
            <div class="form-group">
              <label>Members of...</label>
              <%= select_tag('permission-project-id', projects_grouped_by_programme,
                             prompt: 'any project', class: 'form-control', autocomplete: 'off') -%>
            </div>
            <div class="form-group">
              <label>working at...</label>
              <%= select_tag('permission-institution-id',
                             options_for_select(Institution.all.sort_by(&:title).map { |i| [i.title, i.id] }),
                             prompt: 'any institution', class: 'form-control', autocomplete: 'off') -%>
            </div>
            <div class="form-group">
              <label>can...</label>
              <%= select_tag('permission-project-access-type', policy_selection_options(nil, nil, Policy::ACCESSIBLE), class: 'form-control') -%>
            </div>
        <% end %>
        <%= modal_footer do %>
            <%= link_to('Add', '#', id: 'permission-project-confirm', class: 'btn btn-primary pull-right', 'data-dismiss' => 'modal') %>
        <% end %>
    <% end %>
<% end %>

<%= content_tag :script, permissions_json(@resource.policy), type: 'application/json', id: 'permissions-json' %>

<script>
  var Sharing = {
    addPermission: function (permission) {
      // Update if already existing, otherwise add a new row
      for (var i = 0; i < permissionsTable.permissions.length; i++) {
        var p = permissionsTable.permissions[i];
        if (p.contributor_type == permission.contributor_type && p.contributor_id == permission.contributor_id) {
          permissionsTable.permissions.splice(i, 1, permission);
          return false;
        }
      }

      permissionsTable.permissions.push(permission);
    },

    addPermissionForProject: function (projectId, element) {
      if (projectId > 0) {
        Sharing.addPermission({
          contributor_type: 'Project',
          contributor_id: projectId,
          title: $j(':selected', $j(element)).text(),
          access_type: Sharing.associatedProjectAccessType,
          mandatory: true });
        Sharing.highlightPrivileges();
      }
    }
  };

  // Display person modal
  $j('#add-person-permission-button').click(function () {
    $j('#add-person-permission-modal').modal('show');
    $j('#permission-people-ids').tagsinput('focus');

    return false;
  });

  // Display project/institution/workgroup modal
  $j('#add-project-permission-button').click(function () {
    $j('#add-project-permission-modal').modal('show');

    return false;
  });

  // Add a person permission to the table
  $j('#permission-people-confirm').click(function () {
    var people = $j('#permission-people-ids').tagsinput('items');

    people.forEach(function (person, index) {
      Sharing.addPermission(
          { contributor_type: 'Person',
            contributor_id: person.id,
            title: person.name,
            access_type: parseInt($j('#permission-people-access-type').val()) });
    });

    // Reset form
    $j('#permission-people-ids').tagsinput('removeAll');
  });

  // Add a project/institution/workgroup permission to the table
  $j('#permission-project-confirm').click(function () {
    var projectId = $j('#permission-project-id').val();
    var institutionId = $j('#permission-institution-id').val();
    var projectTitle = $j('#permission-project-id :selected').text();
    var institutionTitle = $j('#permission-institution-id :selected').text();
    var permission = {
      access_type: parseInt($j('#permission-project-access-type').val())
    };

    if (projectId) {
      if (institutionId) {
        permission.contributor_type = 'WorkGroup';
        permission.contributor_id = institutionId; // The "institution" select contains the work group ID in this case
        permission.title = '' + projectTitle + ' @ ' + institutionTitle;
      } else {
        permission.contributor_type = 'Project';
        permission.contributor_id = projectId;
        permission.title = projectTitle;
      }
    } else {
      if (institutionId) {
        permission.contributor_type = 'Institution';
        permission.contributor_id = institutionId;
        permission.title = institutionTitle;
      } else {
        alert('Please select either a project or institution.');
        return false;
      }
    }

    Sharing.addPermission(permission);
  });

  // Update the institution list when a project is selected
  $j('#permission-project-id').change(function () {
    var institutionSelect = $j('#permission-institution-id');
    var projectId = $j(this).val();
    institutionSelect.attr('disabled', 'disabled').spinner('add');

    var url;
    var idIndex;
    // 0: Name, 1: ID, 2: WorkGroupID
    if (projectId) {
      url = Sharing.requestInstitutionsUrl;
      idIndex = 2;
    } else {
      url = Sharing.requestAllInstitutionsUrl;
      idIndex = 1;
    }

    $j.ajax(url, {
          data: { 'id': projectId },
          success: function (data) {
            institutionSelect.html('');
            institutionSelect.html('<option value="">any institution</option>');
            data.institution_list.forEach(function (i) {
              institutionSelect.append('<option value="'+i[idIndex]+'">'+i[0]+'</option>');
            });
          },
          complete: function () {
            institutionSelect.removeAttr('disabled').spinner('remove');
          }
        }
    );
  });

  Sharing.requestInstitutionsUrl = '<%= main_app.request_institutions_projects_path -%>';
  Sharing.requestAllInstitutionsUrl = '<%= main_app.request_all_institutions_path -%>';

  Sharing.accessTypes = {
    noAccess: <%= Policy::NO_ACCESS -%>,
    visible: <%= Policy::VISIBLE -%>,
    accessible: <%= Policy::ACCESSIBLE -%>,
    editing: <%= Policy::EDITING -%>,
    managing: <%= Policy::MANAGING -%>
  };

  Sharing.associatedProjectAccessType = <%= Seek::Config.default_associated_projects_access_type %>;

  var permissionsTable = new Vue({
    el: '#permissions-table',
    data: {
      publicAccessType: <%= @resource.policy.access_type %>,
      permissions: [],
      accessTypes: [
        { title: 'No Access', value: Sharing.accessTypes.noAccess, cellClass: 'no-access' },
        { title: 'View', value: Sharing.accessTypes.visible },
        { title: 'Download', value: Sharing.accessTypes.accessible },
        { title: 'Edit', value: Sharing.accessTypes.editing },
        { title: 'Manage', value: Sharing.accessTypes.managing }
      ]
    },
    methods: {
      deletePermission: function (index) {
        this.permissions.splice(index, 1);
      },
      setAccessType: function (index, accessType) {
        this.permissions[index].access_type = accessType;
      },
      setPublicAccessType: function (accessType) {
        this.publicAccessType = accessType;
      },
      getClass: function (accessType, permissionAccessType, setDisabled) {
        var classes = [];
        if (accessType.value === Sharing.accessTypes.noAccess) {
          classes.push('no-access');
        }

        if (setDisabled && (accessType.value < this.publicAccessType)) {
          classes.push('disabled');
        } else {
          if (accessType.value === Sharing.accessTypes.noAccess) {
            if (permissionAccessType === accessType.value) {
              classes.push('enabled');
            }
          } else if (accessType.value <= permissionAccessType) {
            classes.push('enabled');
          }
        }

        return classes;
      }
    }
  });

  $j(document).ready(function () {
    permissionsTable.permissions = JSON.parse($j('#permissions-json').text());
  });
</script>
