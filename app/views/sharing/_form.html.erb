<%
  object ||= nil
  set_parameters_for_sharing_form object
  @resource.policy.access_type ||= Seek::Config.default_all_visitors_access_type
%>

<%= folding_panel('Sharing', false, :id => 'sharing_form', :body_options => {:id => 'creator_fold_content'},
                  :help_text => "Here you can specify who can <b>see</b>#{', <b>download</b>' if @resource.is_downloadable?} and <b>edit</b> this #{@resource_type}.") do %>
    <div class="alert alert-info">
      <p>
        Here you can specify who can <b>view</b> the summary of<% if @resource.is_downloadable? %>, <b>get</b> access to the content of,<% end %> and <b>edit</b> the <%= @resource_type -%>.
        <%= link_to_function(("More info " + expand_image).html_safe, visual_effect(:toggle_blind, "more_sharing_info", :duration => 0.3)) -%>
      </p>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered permissions-table">
        <thead>
        <tr>
          <th class="name-column"></th>
          <th class="permission-column no-access">No Access</th>
          <th class="permission-column">View</th>
          <th class="permission-column">Download</th>
          <th class="permission-column">Edit</th>
          <th class="permission-column">Manage</th>
          <th class="actions-column"></th>
        </tr>
        </thead>
        <tbody>
        <tr class="permission-row mandatory">
          <td class="name-cell">Public</td>
          <td class="privilege-cell no-access">
            <%= radio_button_tag('policy[access_type]', Policy::NO_ACCESS, (@resource.policy.access_type == Policy::NO_ACCESS), autocomplete: 'off') %>
          </td>
          <% [Policy::VISIBLE, Policy::ACCESSIBLE, Policy::EDITING, Policy::MANAGING].each do |privilege| %>
              <td class="privilege-cell <%= 'disabled' if privilege > Policy.max_public_access_type -%>">
                <% if privilege <= Policy.max_public_access_type %>
                    <%= radio_button_tag('policy[access_type]', privilege, (@resource.policy.access_type == privilege), autocomplete: 'off') %>
                <% end %>
              </td>
          <% end %>
          <td class="actions-cell"></td>
        </tr>
        </tbody>
      </table>
    </div>
    <%= button_link_to('Share with a person', 'add', '#', id: 'add-person-permission-button') %>
    <%= button_link_to('Share with a project/institution', 'add', '#', id: 'add-project-permission-button') %>

    <%= modal(id: 'add-person-permission-modal', size: 'm') do %>
        <%= modal_header('Share with people') %>
        <%= modal_body do %>
            <div class="form-group">
              <label>The following people...</label>
              <%= objects_input('permission-people-ids', [], typeahead: { values: Person.all.map { |p| { id: p.id, name: p.name, hint: p.email } } }) -%>
              <p class="help-block">Start typing a person's name and select from the list that appears. You can select multiple people.</p>
            </div>
            <div class="form-group">
              <label>can...</label>
              <%= select_tag('permission-people-access-type', policy_selection_options(nil, nil, Policy::ACCESSIBLE), class: 'form-control') -%>
            </div>
        <% end %>
        <%= modal_footer do %>
            <%= link_to('Add', '#', id: 'permission-people-confirm', class: 'btn btn-primary pull-right', 'data-dismiss' => 'modal') %>
        <% end %>
    <% end %>

    <%= modal(id: 'add-project-permission-modal', size: 'm') do %>
        <%= modal_header('Share with a project and/or institution') %>
        <%= modal_body do %>
            <div class="form-group">
              <label>Members of...</label>
              <%= select_tag('permission-project-id', projects_grouped_by_programme,
                             prompt: 'any project', class: 'form-control', autocomplete: 'off') -%>
            </div>
            <div class="form-group">
              <label>working at...</label>
              <%= select_tag('permission-institution-id',
                             options_for_select(Institution.all.sort_by(&:title).map { |i| [i.title, i.id] }),
                             prompt: 'any institution', class: 'form-control', autocomplete: 'off') -%>
            </div>
            <div class="form-group">
              <label>can...</label>
              <%= select_tag('permission-project-access-type', policy_selection_options(nil, nil, Policy::ACCESSIBLE), class: 'form-control') -%>
            </div>
        <% end %>
        <%= modal_footer do %>
            <%= link_to('Add', '#', id: 'permission-project-confirm', class: 'btn btn-primary pull-right', 'data-dismiss' => 'modal') %>
        <% end %>
    <% end %>
<% end %>

<%= content_tag :script, permissions_json(@resource.policy), type: 'application/json', id: 'permissions-json' %>

<script>
  var Sharing = {
    renderPermissions: function () {
      var permissions = JSON.parse($j('#permissions-json').text());
      permissions.forEach(function (permission) {
        var row = HandlebarsTemplates['sharing/permission_row']({ permission: permission, accessTypes: Sharing.accessTypes });
        $j('.permissions-table').append(row);
      });
    },

    // Display tick icons in all the privileges up to and including the selected one.
    // e.g. clicking on "Edit" should show ticks in the "View" and "Download" cells
    highlightPrivileges: function () {
      $j('.permissions-table .permission-row').each(function () {
        $j('td', $j(this)).removeClass('enabled');
        var cell = $j('input[type=radio]:checked', $j(this)).parent('.privilege-cell');
        var otherCells = cell.prevAll('.privilege-cell').andSelf();
        if (!cell.hasClass('no-access')) {
          otherCells = otherCells.not('.no-access');
        }
        otherCells.addClass('enabled');
      });
    },

    // Show that the user cannot apply privileges than what is set for "Everyone"
    setMinimumPrivileges: function () {
      var index = $j('[name="policy[access_type]"]').index($j('[name="policy[access_type]"]:checked'));
      $j('.permission-row:gt(0)').each(function () {
        $j('.privilege-cell', $j(this)).removeClass('disabled');
        $j('.privilege-cell:lt(' + index + ')', $j(this)).removeClass('enabled').addClass('disabled');
      });
    },

    addPermission: function (permission) {
      // Check the row doesn't already exist in the table
      if (!$j('[data-contributor-id="'+permission.contributor_id+'"][data-contributor-type="'+permission.contributor_type+'"]').length) {
        permission.index = permission.index || Sharing.generateUniqueIndex();
        var row = $j(HandlebarsTemplates['sharing/permission_row']({ permission: permission, accessTypes: Sharing.accessTypes }));

        if (permission.mandatory)
          row.addClass('mandatory');

        // Ensure "mandatory" permissions are at the top
        if (permission.mandatory)
          row.insertAfter('.permissions-table .permission-row.mandatory:last');
        else
          row.appendTo('.permissions-table');
      }
    },

    addPermissionForProject: function (projectId, element) {
      if (projectId > 0) {
        Sharing.addPermission({
          contributor_type: 'Project',
          contributor_id: projectId,
          title: $j(':selected', $j(element)).text(),
          access_type: Sharing.associatedProjectAccessType,
          mandatory: true });
        Sharing.highlightPrivileges();
      }
    },

    generateUniqueIndex: function () {
      return (new Date().valueOf() * 100 + $j('.permissions-table .permission-row').length);
    }
  };

  $j(document).ready(function () {
    Sharing.renderPermissions();
    Sharing.highlightPrivileges();
    Sharing.setMinimumPrivileges();
  });

  $j('.permissions-table').on('click', '.privilege-cell', function () {
    if (!$j(this).hasClass('disabled')) {
      $j('input[type=radio]', $j(this)).prop('checked', true);
      Sharing.highlightPrivileges();
      Sharing.setMinimumPrivileges();
    }
  });

  $j('.permissions-table').on('change', '.permission-row input[type=radio]', function () {
    Sharing.highlightPrivileges();
    Sharing.setMinimumPrivileges();
  });

  $j('.permissions-table').on('click', '.permission-row .remove-permission', function () {
    $j(this).parents('.permission-row').remove();

    return false;
  });

  // Display person modal
  $j('#add-person-permission-button').click(function () {
    $j('#add-person-permission-modal').modal('show');
    $j('#permission-people-ids').tagsinput('focus');

    return false;
  });

  // Display project/institution/workgroup modal
  $j('#add-project-permission-button').click(function () {
    $j('#add-project-permission-modal').modal('show');

    return false;
  });

  // Add a person permission to the table
  $j('#permission-people-confirm').click(function () {
    var people = $j('#permission-people-ids').tagsinput('items');

    people.forEach(function (person, index) {
      Sharing.addPermission(
          { contributor_type: 'Person',
            contributor_id: person.id,
            title: person.name,
            access_type: $j('#permission-people-access-type').val() });
    });

    Sharing.highlightPrivileges();
    // Reset form
    $j('#permission-people-ids').tagsinput('removeAll');
  });

  // Add a project/institution/workgroup permission to the table
  $j('#permission-project-confirm').click(function () {
    var projectId = $j('#permission-project-id').val();
    var institutionId = $j('#permission-institution-id').val();
    var projectTitle = $j('#permission-project-id :selected').text();
    var institutionTitle = $j('#permission-institution-id :selected').text();
    var permission = {
      access_type: $j('#permission-project-access-type').val()
    };

    if (projectId) {
      if (institutionId) {
        permission.contributor_type = 'WorkGroup';
        permission.contributor_id = institutionId; // The "institution" select contains the work group ID in this case
        permission.title = '' + projectTitle + ' @ ' + institutionTitle;
      } else {
        permission.contributor_type = 'Project';
        permission.contributor_id = projectId;
        permission.title = projectTitle;
      }
    } else {
      if (institutionId) {
        permission.contributor_type = 'Institution';
        permission.contributor_id = institutionId;
        permission.title = institutionTitle;
      } else {
        alert('Please select either a project or institution.');
        return false;
      }
    }

    Sharing.addPermission(permission);
    Sharing.highlightPrivileges();
  });

  // Update the institution list when a project is selected
  $j('#permission-project-id').change(function () {
    var institutionSelect = $j('#permission-institution-id');
    var projectId = $j(this).val();
    institutionSelect.attr('disabled', 'disabled').spinner('add');

    var url;
    var idIndex;
    // 0: Name, 1: ID, 2: WorkGroupID
    if (projectId) {
      url = Sharing.requestInstitutionsUrl;
      idIndex = 2;
    } else {
      url = Sharing.requestAllInstitutionsUrl;
      idIndex = 1;
    }

    $j.ajax(url, {
          data: { 'id': projectId },
          success: function (data) {
            institutionSelect.html('');
            institutionSelect.html('<option value="">any institution</option>');
            data.institution_list.forEach(function (i) {
              institutionSelect.append('<option value="'+i[idIndex]+'">'+i[0]+'</option>');
            });
          },
          complete: function () {
            institutionSelect.removeAttr('disabled').spinner('remove');
          }
        }
    );
  });

  Sharing.requestInstitutionsUrl = '<%= main_app.request_institutions_projects_path -%>';
  Sharing.requestAllInstitutionsUrl = '<%= main_app.request_all_institutions_path -%>';

  Sharing.accessTypes = {
    noAccess: <%= Policy::NO_ACCESS -%>,
    visible: <%= Policy::VISIBLE -%>,
    accessible: <%= Policy::ACCESSIBLE -%>,
    editing: <%= Policy::EDITING -%>,
    managing: <%= Policy::MANAGING -%>
  };

  Sharing.associatedProjectAccessType = <%= Seek::Config.default_associated_projects_access_type %>;
</script>
