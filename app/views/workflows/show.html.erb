<%= render partial: 'general/item_title', locals: { item: @workflow,
                                                    version: @display_workflow.version,
                                                    buttons_partial: 'assets/asset_buttons' } -%>

<%= render partial: 'assets/upload_new_version_form', locals: { resource: @workflow } -%>

<div class="row">
  <div class="col-md-9 col-sm-8 box_about_actor">
    <ul class="nav nav-tabs" role="tablist">
      <li class="active">
        <a href="#overview" aria-controls="overview" role="tab" data-toggle="tab">Overview</a>
      </li>
      <li>
        <a href="#files" aria-controls="files" role="tab" data-toggle="tab">Files</a>
      </li>
    </ul>

    <div class="tab-content">
      <div role="tabpanel" class="tab-pane active" id="overview">
        <% if @display_workflow.maturity_level %>
          <p>
            <%= maturity_badge(@display_workflow.maturity_level) %>
          </p>
        <% end %>

        <%= item_description(@display_workflow.description) %>

        <% begin %>
          <% if @display_workflow.diagram_exists? || @display_workflow.can_render_diagram? %>
            <div class="row">
              <div class="col-md-12">
                <div class="workflow-diagram">
                  <%= image_tag(diagram_workflow_path(@workflow, version: @display_workflow.version)) %>
                </div>
              </div>
            </div>
          <% end %>
        <% rescue StandardError => e %>
          <% Rails.logger.error(e.inspect) %>
          <% Rails.logger.error(e.backtrace.join("\n")) %>
          <div class="alert alert-warning">Could not render the workflow diagram.</div>
        <% end %>

        <div class="row">
          <div class="col-md-6">
            <%= persistent_resource_id(@display_workflow) %>

            <%= render partial: 'assets/special_auth_code_display', locals: { resource: @workflow } %>
            <%= render partial: 'assets/asset_doi', locals: { displayed_resource: @display_workflow } %>
          </div>
        </div>

        <% unless @display_workflow.internals.empty? %>
          <div class="row">
            <div class="col-md-12">
              <%= render partial: 'workflows/workflow_internals', locals: { workflow: @display_workflow } %>
            </div>
          </div>
        <% end %>

        <%# rendered_asset_view(@display_workflow) %>

        <% if Seek::Config.isa_enabled %>
          <%= render partial: 'general/isa_graph', locals: { root_item: @workflow, deep: true, include_parents: true } %>
        <% end %>
      </div>

      <div role="tabpanel" class="tab-pane" id="files">
        <%= modal(size: 'lg', id: 'git-preview-modal', class: 'git-browser-modal') do %>
          <%= modal_header('Preview') %>

          <%= modal_body do %>

          <% end -%>
        <% end %>

        <%= render partial: 'git/jstree', locals: { tree: @display_workflow.tree, opts: { id: 'workflow-jstree' } } %>

        <script>
            $j(document).ready(function () {
                $j("#workflow-jstree").on('dblclick','.jstree-anchor', function (e) {
                    var jstree = $j.jstree.reference(this);
                    var node = jstree.get_node(this);
                    if (node.type === 'blob') {
                        var path = '<%= workflow_git_blob_path(@workflow, path: '__replaceme__') %>'.replace('__replaceme__', node.id)
                        $j.ajax(path, {
                            success: function (html) {
                                $j('#git-preview-modal .modal-body').html(html);
                                $j('#git-preview-modal').modal('show');
                            }
                        });
                    }
                });
            })
        </script>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-4">
    <%= render partial: 'assets/resource_main_content_right', locals: { resource: @workflow, versioned_resource: @display_workflow } %>
  </div>
</div>

<%= render partial: 'assets/resource_version_details', locals: { displayed_resource: @display_workflow, resource: @workflow } -%>

<%# get, classify and authorize all assets for this project -%>
<%= render partial: 'general/items_related_to', object: @workflow %>
