<% text = publication_form;
   help_text =  "Here you can edit the metadata of the publication. These data can be edited only when the publication is registered manually."

%>

<%= folding_panel("Publication", false, id: "edit_publication_form",
    help_text: help_text ) do %>

  <div role="tabpanel" class="tab-pane" id="Create">

      <%= publication_form.hidden_field :parent_name %>
      <%= publication_form.hidden_field :registered_mode %>

      <div class="form-horizontal">
      <div class="form-group">
        <%= label_tag :pubmed_id, "Pubmed ID", :class => 'control-label col-sm-2', 'data-tooltip' => "Search metedata by PubMed ID" %>
        <div class="col-sm-6">
          <%= publication_form.text_field :pubmed_id, :class => 'form-control' %>
        </div>
        <div class="col-sm-4">
          <button id="retrieve_from_pubmed" class="btn btn-default">PUBMED</button>
        </div>
      </div>
      <div class="form-group">
        <%= label_tag :doi, "DOI", :class => 'control-label col-sm-2','data-tooltip' => "Search metedata by DOI" %>
        <div class="col-sm-6">
          <%= publication_form.text_field :doi, :class => 'form-control'%>
        </div>
        <div class=" col-sm-4">
          <button id="retrieve_from_crossref" class="btn btn-default">DOI</button>
        </div>
      </div>
      <div class="form-group">
        <%= label_tag :title, 'Title', :class => 'control-label col-sm-2' %>
        <div class="col-sm-10">
          <%= publication_form.text_area :title, :class => 'form-control', :rows => 2, :cols => 100 %>
        </div>
      </div>
      <div class="form-group">
        <%= label_tag :abstract, nil, :class => 'control-label col-sm-2' %>
        <div class="col-sm-10">
          <%= publication_form.text_area :abstract, :class => 'form-control', :rows => 5, :cols => 100 %>
        </div>
      </div>
      <div class="form-group">
        <%= label_tag :journal, nil, :class => 'control-label col-sm-2' %>
        <div class="col-sm-10">
          <%= publication_form.text_field :journal, :class => 'form-control' %>
        </div>
      </div>
      <div class="form-group">
        <%= label_tag :citation, nil, :class => 'control-label col-sm-2' %>
        <div class="col-sm-10">
          <%= publication_form.text_field :citation, :class => 'form-control' %>
        </div>
      </div>
      <div class="form-group">
        <%= label_tag :published_date, nil, :class => 'control-label col-sm-2' %>
        <div class="col-sm-10">
          <%= publication_form.text_field :published_date, data: { calendar: true }, class: 'calendar form-control' %>
        </div>
      </div>
      </div>
  </div>
<% end %>

<script type="text/javascript">


    jQuery('#retrieve_from_crossref').on('click', function(e){
            e.preventDefault(); // prevent the default form submit action

            var doi = jQuery('#publication_doi').val();
            doi = doi.replace(/^(https?:\/\/)?(dx\.)?doi\.org/, '');

            jQuery.ajax({
                url: 'https://doi.org/' + doi,
                accepts: { 'citeproc': "application/vnd.citationstyles.csl+json" },
                dataType: 'json',
                success: function(data, textStatus, jqXHR) {
                    //console.log("DOI:", data);
                    jQuery('#publication_doi').parents('.form-group').removeClass('has-error');
                    jQuery('#publication_doi').parents('.form-group').addClass('has-success');
                    jQuery('#crossref_id').val(data.DOI);
                    jQuery('#publication_title').val(data.title);
                    jQuery('#publication_journal').val(data["container-title"]);
                    published_data = data["published-online"] || data["published-print"] || data["accepted"];
                    //console.log("published_data:", published_data);
                    year=published_data["date-parts"][0][0];
                    month= published_data["date-parts"][0][1];
                    day= published_data["date-parts"][0][2];
                    var date_published = year+"-"+month+"-"+day;
                    jQuery('#publication_published_date').val(date_published);

                    var authorlist = [];
                    data.author.forEach(function(item,index){
                        author_name = item.given+' '+item.family;
                        console.log ('author_name:'+ author_name);
                        console.log ('index:'+ index);
                        jQuery('#author-'+index).text (author_name);
                        //jQuery('#author-'+index+'-value').val (author_name);

                        jQuery('#publication_publication_authors_attributes_'+index+'_person_first_name').val (item.given);
                        jQuery('#publication_publication_authors_attributes_'+index+'_person_last_name').val (item.family);


                        //jQuery('#publication_publication_authors_attributes_0_person_id').val(author_name);
                        //document.getElementById('author-2').innerHTML =author_name;
                    });

                },

                statusCode: {
                    // 200: function() { console.log("DOI: " + doi + " The request was OK.");},
                    204: function() { console.log("DOI: " + doi + " The request was OK but there was no metadata available.");},
                    404: function() { console.log("DOI: " + doi + " The DOI requested doesn't exist.");},
                    406: function() { console.log("DOI: " + doi + " Can't serve any requested content type.");}
                },
                error: function() {
                    jQuery('#publication_doi').parents('.form-group').removeClass('has-success');
                    jQuery('#publication_doi').parents('.form-group').addClass('has-error');
                }
            });
        });
    jQuery('#retrieve_from_pubmed').on('click', function(e){
            e.preventDefault(); // prevent the default form submit action
            var pubmedid = jQuery('#publication_pubmed_id').val();
            jQuery.ajax({
                url: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi',
                data: {
                    'db': 'pubmed',
                    'id': pubmedid,
                    'retmode': 'xml',
                    'retmax': 1
                },
                dataType: 'xml',
                success: function(data, textStatus, jqXHR) {
                    jQuery('#publication_pubmed_id').parents('.form-group').removeClass('has-error');
                    jQuery('#publication_pubmed_id').parents('.form-group').addClass('has-success');
                    var doc = jQuery(data);
                    console.log("Pudmed:");
                    console.log(data);
                    var doi_elem = jQuery(data).find('PubmedArticleSet > PubmedArticle > PubmedData > ArticleIdList > ArticleId[IdType="doi"]');
                    if( doi_elem.length != 0) {
                        jQuery('#publication_doi').val(doi_elem.html());
                    }

                    var medline_citation = jQuery(data).find('PubmedArticleSet > PubmedArticle > MedlineCitation');

                    var title_elem = medline_citation.find('Article > ArticleTitle');
                    if( title_elem.length != 0) {
                        jQuery('#publication_title').val(title_elem.html());
                    }
                    var abstract_elem = medline_citation.find('Article > Abstract > AbstractText');
                    if( abstract_elem.length != 0) {
                        jQuery('#publication_abstract').val(abstract_elem.html());
                    }
                    var journal_elem = medline_citation.find('Article > Journal > Title');
                    if( journal_elem.length != 0) {
                        jQuery('#publication_journal').val(journal_elem.html());
                    }
                    var published_date = medline_citation.find('Article > ArticleDate');
                    if( published_date.length != 0) {
                        year=published_date.find('Year').html();
                        console.log("year:"+year);
                        month= published_date.find('Month').html();
                        console.log("month:"+month);

                        day= published_date.find('Day').html();
                        console.log("day:"+day);
                        var date_published_string = year+"-"+month+"-"+day;
                        console.log("date_published"+date_published_string);
                        jQuery('#publication_published_date').val(date_published_string);
                    }
                },
                error: function() {
                    jQuery('#publication_pubmed_id').parents('.form-group').removeClass('has-success');
                    jQuery('#publication_pubmed_id').parents('.form-group').addClass('has-error');
                }
            });
        });

</script>