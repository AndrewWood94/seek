<%= javascript_include_tag 'controlled_vocabs' %>
<% remote ||= false %>

<%= form_for(@sample_controlled_vocab, remote: remote) do |f| %>

  <span id="controlled-vocab-errors">
        <%= f.error_messages %>
    </span>

  <div class="form-group">
    <label>Title</label><%= required_span %>
    <%= f.text_field :title, :class => 'form-control', :placeholder => 'Controlled vocabulary name' %>
  </div>

  <h3>Ontology</h3>
  <div class="form-group">
    <label>Ontology</label>
    <%= f.select :source_ontology, ebi_ontology_choices, { include_blank: 'no ontology' }, class: 'form-control' -%>
    <br/>

    <div id='ontology-root-uri' style="display:none;">
      <div class="help-block">
        You have selected the <a id="selected-ols-link" href="" target="_blank"></a>,
        click the link to browse on the Ontology Lookup Service in another tab and find the suitable root term URI.
        You should then copy that URI into the field below.
      </div>
      <div>
        <label>Root term</label>
        <%= f.text_field :ols_root_term_uri, :class => 'form-control', :placeholder => 'e.g. http://www.ebi.ac.uk/efo/EFO_0000635' %>
      </div>
      <div>
        <%= submit_tag 'Fetch', id: 'fetch-ontology-terms-submit', :class => 'btn btn-primary' %>
      </div>
    </div>

  </div>

  <h3>Terms</h3>

  <span id='fetch-terms-spinner'></span>
  <div id='fetch-error-message' class="alert alert-danger" style="display:none;"></div>

  <div id='controlled-vocab-terms'>
    <div id='controlled-vocab-terms-fixed'>
      <table id="new-terms" class="table" style="width:100%;">
        <thead>
        <th>Label<span class="required">*</span></th>
        <th>IRI</th>
        <th>Parent IRI</th>
        <th></th>
        </thead>
        <tbody>
        <% @sample_controlled_vocab.sample_controlled_vocab_terms.each_with_index do |term, index| %>
          <%= f.fields_for :sample_controlled_vocab_terms, term do |terms_f| %>

            <tr class="sample-cv-term" data-index="<%= index %>">
              <td><%= terms_f.text_field :label, :class => 'form-control' %></td>
              <td><%= terms_f.text_field :iri, :class => 'form-control' %></td>
              <td><%= terms_f.text_field :parent_iri, :class => 'form-control' %></td>
              <td>
                <div class="btn-group" data-toggle="buttons">
                  <%= hidden_field_tag "sample_controlled_vocab[sample_controlled_vocab_terms_attributes][#{index}][_destroy]", '0', :autocomplete => 'off' %>
                  <label class="btn btn-danger">
                    Remove
                    <%= check_box_tag "sample_controlled_vocab[sample_controlled_vocab_terms_attributes][#{index}][_destroy]", '1', false,
                                      :class => 'destroy-attribute', :autocomplete => 'off' %>
                  </label>
                </div>

              </td>
            </tr>
          <% end %>
        <% end %>
        <tr id='add-term-button-row'>

        </tr>
        </tbody>
      </table>
    </div>
    <div>
      <%= button_link_to('Add new term', 'add', '#', :id => 'add-term') %>
      <%= button_link_to('Remove all terms', 'destroy', '#', :id => 'clear-terms', class:'btn btn-danger') %>
    </div>
  </div>


  <div class="actions">
    <%= f.submit (@sample_controlled_vocab.new_record? ? 'Create' : 'Update'), :class => 'btn btn-primary', id: 'submit-button' %>
    <% unless remote %>
      or
      <%= cancel_button(@sample_controlled_vocab.new_record? ? sample_controlled_vocabs_path : sample_controlled_vocab_path(@sample_controlled_vocab)) %>
    <% end %>
  </div>

<% end %>

<table id="new-term-row" style="display: none">
  <tbody>
  <tr class="sample-cv-term success" data-index="--index--">
    <td>
      <input class="form-control" id="sample_controlled_vocab_sample_controlled_vocab_terms_attributes_--index--_label" name="sample_controlled_vocab[sample_controlled_vocab_terms_attributes][--index--][label]" type="text">
    </td>
    <td>
      <input class="form-control" id="sample_controlled_vocab_sample_controlled_vocab_terms_attributes_--index--_iri" name="sample_controlled_vocab[sample_controlled_vocab_terms_attributes][--index--][iri]" type="text">
    </td>
    <td>
      <input class="form-control" id="sample_controlled_vocab_sample_controlled_vocab_terms_attributes_--index--_parent_iri" name="sample_controlled_vocab[sample_controlled_vocab_terms_attributes][--index--][parent_iri]" type="text">
    </td>
    <td>
      <div class="btn-group" data-toggle="buttons">
        <%= hidden_field_tag "sample_controlled_vocab[sample_controlled_vocab_terms_attributes][--index--][_destroy]", '0', :autocomplete => 'off' %>
        <label class="btn btn-danger">
          Remove
          <%= check_box_tag "sample_controlled_vocab[sample_controlled_vocab_terms_attributes][--index--][_destroy]", '1', false,
                            :class => 'destroy-attribute', :autocomplete => 'off' %>
        </label>
      </div>

    </td>
  </tr>
  </tbody>
</table>

<script>
    $j(document).ready(function () {
        initialiseCVForm('<%= fetch_ols_terms_sample_controlled_vocabs_path %>');
    });
</script>