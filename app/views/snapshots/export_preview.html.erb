<div class="row">
  <div class="col-md-8 col-md-push-2">
    <%= panel("Confirmation") do %>
        <%= form_tag(export_investigation_snapshot_path(@investigation, @snapshot.snapshot_number), method: :post) do %>
            <%= image_tag('logos/zenodo.png', :class => 'zenodo-publish') %>
            <p>
              You are about to export the investigation:
              <strong><%= @investigation.title %></strong> to Zenodo. <br/>
              Please fill out some additional metadata required by Zenodo before submitting.
            </p>

            <div class="form-group" id="access-right-section">
              <label>Access Right</label>
              <div class="btn-group btn-group-justified" data-toggle="buttons">
                <label class="btn btn-default active">
                  <input type="radio" name="metadata[access_right]" id="access-right-open" value="open" autocomplete="off" checked>
                  Open
                </label>
                <label class="btn btn-default">
                  <input type="radio" name="metadata[access_right]" id="access-right-embargoed" value="embargoed" autocomplete="off">
                  Embargoed
                </label>
                <label class="btn btn-default">
                  <input type="radio" name="metadata[access_right]" id="access-right-restricted" value="restricted" autocomplete="off">
                  Restricted
                </label>
                <label class="btn btn-default">
                  <input type="radio" name="metadata[access_right]" id="access-right-closed" value="closed" autocomplete="off">
                  Closed
                </label>
              </div>
            </div>

            <div class="form-group" id="license-section">
              <label>License</label>
              <%= license_select('metadata[license]', 'CC-BY-4.0', :id => 'license-select', :class => 'form-control') %>
              <span class="help-block">
                For more information on this license, please visit
                <a id="license-url" href="" target="_blank"></a>
              </span>
            </div>

            <div class="form-group" id="access-conditions-section" style="display: none">
              <label>Access Conditions</label>
              <%= text_area_tag('metadata[access_conditions]','', :class => 'form-control') %>
              <span class="help-block">The conditions under which this investigation can be accessed.</span>
            </div>

            <div class="form-group" id="embargo-date-section" style="display: none">
              <label>Embargo Date</label>
              <%= text_field_tag('metadata[embargo_date]','', :placeholder => 'YYYY-MM-DD', :class => 'form-control') %>
              <span class="help-block">The date at which the embargo is lifted, e.g. 2015-08-15.</span>
            </div>

            <hr/>

            <label>Creators</label>
            <div class="row">
              <div class="col-sm-8">
                <span class="help-block">The following people will be credited as "creators" of this investigation.</span>
              </div>
              <div class="col-sm-4">
                <div class="input-group input-group-sm">
                  <input id="add-creator" type="text" class="form-control" placeholder="Add another creator (e.g. Doe, John)">
                  <span class="input-group-btn">
                    <button id="add-creator-button" class="btn btn-success" type="button">Add</button>
                  </span>
                </div>
              </div>
            </div>
            <div id="creators">
              <span class="subtle">No one</span>
            </div>

            <hr/>

            <p class="text-center">
              <%= submit_tag 'Export', :class => 'btn btn-primary' %>
              <%= link_to 'Cancel', investigation_path(@investigation), :class => 'btn btn-default' %>
            </p>
        <% end %>
    <% end %>
  </div>
</div>

<script>
    var creatorList = <%= @snapshot.all_related_people.map {|p| {name: "#{p.last_name}, #{p.first_name}"} }.sort.to_json.html_safe %>;

    function setLicenseUrl() {
        var element = $j('#license-select option:selected');
        var link = $j('#license-url');

        link.attr('href', element.data('url'));
        link.html(element.data('url'));
    }

    function enableSection(sectionElement) {
        sectionElement.show().children(":input").prop("disabled", false);
    }

    function disableSection(sectionElement) {
        sectionElement.hide().children(":input").prop("disabled", true);
    }

    function toggleSections() {
        var licenseSection = $j('#license-section');
        var dateSection = $j('#embargo-date-section');
        var conditionsSection = $j('#access-conditions-section');

        if (this.value == 'open') {
            enableSection(licenseSection);
            disableSection(dateSection);
            disableSection(conditionsSection);
        } else if (this.value == 'embargoed') {
            enableSection(licenseSection);
            enableSection(dateSection);
            disableSection(conditionsSection);
        } else if (this.value == 'restricted') {
            disableSection(licenseSection);
            disableSection(dateSection);
            enableSection(conditionsSection);
        } else if (this.value == 'closed') {
            disableSection(licenseSection);
            disableSection(dateSection);
            disableSection(conditionsSection);
        }
    }

    function renderCreatorList() {
        var html = '';

        creatorList.each(function (c) {
            html += HandlebarsTemplates['zenodo/creator'](c);
        });

        $j('#creators').html(html);
    }

    function addCreator() {
        var creator = { name: $j('#add-creator').val() };
        creatorList.push(creator);
        $j('#add-creator').val('');
        // I'm not calling renderCreatorList() here because it will forget which checkboxes have been
        //   checked/unchecked
        $j('#creators').append(HandlebarsTemplates['zenodo/creator'](creator));
    }

    $j(document).ready(function () {
        $j('#license-select').change(setLicenseUrl);
        $j('#access-right-section input:radio').change(toggleSections);
        $j('#add-creator-button').click(addCreator);
        $j('#add-creator').keypress(function(e) {
            if(e.which == 13) {
                addCreator();
                e.preventDefault();
                return false;
            }
        });

        toggleSections();
        setLicenseUrl();
        renderCreatorList();
    });
</script>
