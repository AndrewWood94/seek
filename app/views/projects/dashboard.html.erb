<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>

<%= render partial: 'general/page_title', locals: { title: "#{t('project').capitalize} Dashboard" } %>

<div class="row">
  <div class="col-sm-4">
    <%= panel('Most viewed assets', id: 'most_viewed') do %>
      <%= render partial: 'projects/dashboard/most', locals: { action: 'show' } %>
    <% end %>
    <%= panel('Most downloaded assets', id: 'most_downloaded') do %>
      <%= render partial: 'projects/dashboard/most', locals: { action: 'download' } %>
    <% end %>
    <%= panel('Most active contributors', id: 'active_contributors') do %>
      <div class="most-activity" data-stats-url="<%= contributors_project_stats_path(@project) -%>">
        <div class="text-right">
          <div class="form-inline">
            <%= render partial: 'projects/dashboard/time_controls' -%>
          </div>
        </div>

        <ul class="mini-resource-list"></ul>
      </div>
    <% end %>
  </div>
  <div class="col-sm-8">
    <div>
      <%= panel('Contributions', id: 'contributions') do %>
        <%= render partial: 'projects/dashboard/contributions' %>
      <% end %>
    </div>
    <div class="row">
      <div class="col-sm-6">
        <%= panel('Contributions', id: 'published_assets') do %>
          <%= render partial: 'projects/dashboard/published_assets' %>
        <% end %>
      </div>
      <div class="col-sm-6">
      </div>
    </div>
  </div>
</div>

<script>
    $j(document).ready(function () {
        $j('[data-dashboard-field="period-start"], [data-dashboard-field="period-end"]').each(function () {
            $j(this).datetimepicker({
                format: 'YYYY-MM-DD'
            });
        });

        $j('[data-dashboard-field="period-select"]').change(function () {
            var wrapper = $j(this).parent().parent();
            if ($j(this).val() === 'custom') {
                $j('.custom-range-field', wrapper).fadeIn();
            } else {
                $j('.custom-range-field', wrapper).fadeOut();
                $j('[data-dashboard-field="period-start"]', wrapper).val($j(this).val());
                $j('[data-dashboard-field="period-end"]', wrapper).val(new Date().toISOString().substr(0,10));
            }
        });

        $j('[data-dashboard-field="period-select"]').change();

        $j('.most-activity').each(function () {
            var container = $j(this);
            var getStats = function () {
                var startDate = container.find('[data-dashboard-field="period-start"]').val();
                var endDate = container.find('[data-dashboard-field="period-end"]').val();

                container.spinner('add');

                $j.ajax({ url: container.data('statsUrl'),
                    data: {
                        start_date: startDate,
                        end_date: endDate,
                    },
                    success: function (resp) {
                        var list = container.find('ul.mini-resource-list');
                        list.html('');
                        resp.forEach(function (activity) {
                            list.append(HandlebarsTemplates['projects/dashboard/activity_listing'](activity));
                        });
                    },
                    error: function () {
                        container.html('<div class="alert alert-danger">An error occurred whilst fetching stats.</div>');
                    },
                    complete: function () {
                        container.spinner('remove');
                    }
                });
            };

            $j('[data-dashboard-field="period-select"]', container).change(function () {
                if ($j(this).val() !== 'custom') {
                    getStats();
                }
            });
            $j('[data-dashboard-period-btn]', container).click(function () { getStats(); return false; });
            $j('[data-dashboard-field="period-select"]', container).change(); // triggers initial load
        });

    });
    //    var getPage = function (page, element, refresh) {
    //        element.spinner('add');
    //        var data = { query: page };
    //        if (refresh) {
    //            data.refresh = true;
    //        }
    //        $j.ajax({ url: '<%# stats_project_dashboard_path(@project) -%>',
    //            data: { query: page },
    //            success: function (resp) {
    //                element.html(resp);
    //            },
    //            error: function () {
    //                element.html('<div class="alert alert-danger">An error occurred whilst fetching your query.</div>');
    //            },
    //            complete: function () {
    //                element.spinner('remove');
    //            }
    //        })
    //    };
//
    //    $j('.dashboard-panelid: ').each(function () {
    //        var panel = this;
    //        var panelBody = $j(this).find('.panel-body');
//
    //        getPage(panel.id, panelBody);
//
    //        $j(panel).find('.dashboard-refresh-btn').click(function () {
    //            getPage(panel.id, panelBody, true);
    //        })
    //    });
//
    //});
</script>