<%
  resource_text ||= text_for_resource(resource)

  assay_assets = resource.assay_assets.where(asset_type: 'Sample').includes(:asset)
  associated_samples_json = assay_assets.map do |aa|
    { title: aa.asset.title, id: aa.asset_id,
      direction: { id: aa.direction, text: direction_name(aa.direction) } }
  end.to_json
-%>

<%= folding_panel("Samples", assay_assets.blank?, :body_options => {:id => 'associate_sample_fold_content'},
                  :help_text => "Here you associate Samples in SEEK to this #{resource_text}.") do %>

    <p>The following Samples are involved in this <%= resource_text -%>:</p>

    <%= associations_list('sample_to_list', 'associations/sample', associated_samples_json,
                          :empty_text => 'No samples') %>

    <hr/>

    <%= association_selector('sample_to_list', 'Add individual samples', 'Select samples') do %>
        <label>Select samples</label>
        <%= filterable_association_select(filter_samples_path(:assay_id => resource.id), :multiple => true) do %>
            <%= render :partial => 'samples/association_preview', :collection => Sample.limit(20),
                       :locals => { :existing => resource.samples }
            %>
        <% end %>

        <hr/>

        <div class="form-group">
          <label>Select sample direction</label>
          <%= select_tag(:direction, direction_options, :class => 'form-control', 'data-role' => 'seek-association-common-field') %>
        </div>
    <% end %>

    <%= button_link_to('Add samples from data file', 'add', '#', 'data-toggle' => 'modal', 'data-target' => "#AddSamplesFromDataFileModal") %>
    <%= modal(id: 'AddSamplesFromDataFileModal', size: 'xl', 'data-role' => 'seek-wizard') do %>
        <%= modal_header('Add samples from data file') %>
        <%= modal_body do %>
            <div data-role="seek-wizard-nav"></div>
            <div data-role="seek-wizard-step" data-step-name="Select data file">
              <label>Select data file</label>
              <%= filterable_association_select(filter_data_files_path) do %>
                  <%= render :partial => 'data_files/association_preview', :collection => DataFile.all_authorized_for('view').first(20),
                             :locals => { :existing => resource.samples }
                  %>
              <% end %>
            </div>
            <div data-role="seek-wizard-step" data-step-name="Select samples">
              <label>Select samples</label>
              <a id="data-file-samples-select-all" href="#" class="btn btn-default btn-xs">Select all</a>
              <a id="data-file-samples-select-none" href="#" class="btn btn-default btn-xs">Select none</a>
              <div id="data-file-samples-table">
                <%#TODO: Change me %>
                <%= render :partial => 'samples/table_view', :locals => { :samples => Sample.where(:sample_type_id => SampleType.last.id)} %>
              </div>
            </div>
            <div data-role="seek-wizard-step" data-step-name="Select sample direction">
              <div class="form-group">
                <label>Select sample direction</label>
                <%= select_tag(:direction, direction_options, :class => 'form-control', 'data-role' => 'seek-association-common-field') %>
              </div>
            </div>
        <% end %>
        <%= modal_footer do %>
            <a data-role="seek-wizard-next-btn" href="#" class="pull-right btn btn-default">Next</a>
            <a data-role="seek-wizard-prev-btn" href="#" class="pull-left btn btn-default">Previous</a>
            <%= confirm_association_button('Add samples', id: 'add-batch-sample-btn', style: 'display: none',
                                           class: 'btn btn-primary pull-right', 'data-dismiss' => 'modal') %>
        <% end %>
    <% end %>
    <%= button_link_to('Clear all samples', 'destroy', '#', id: 'clear-all-samples-btn') %>

    <script>
        var samplesList = new Associations.List('associations/sample', $j('#sample_to_list'));
        var batchSamplesForm = new Associations.Form(samplesList, $j('#AddSamplesFromDataFileModal'));
        $j('#AddSamplesFromDataFileModal :input[data-role="seek-association-common-field"]').each(function () {
          $j(this).data('attributeName', this.name);
          this.name = '';
          batchSamplesForm.commonFieldElements.push($j(this));
        });

        var samplesTable = $j('#data-file-samples-table table').DataTable({
          "lengthMenu": [ 5, 10, 25, 50, 75, 100 ],
          "select": {
            style: 'multi'
          },
          "columnDefs": [{
            "targets": [ 0, 1 ],
            "visible": false,
            "searchable": false
          }]
        });

        $j('#add-batch-sample-btn').click(function () {
          batchSamplesForm.submit();
        });

        $j('#data-file-samples-select-all').click(function () {
          samplesTable.rows().select();
          return false;
        });
        $j('#data-file-samples-select-none').click(function () {
          samplesTable.rows().deselect();
          return false;
        });
        $j('#clear-all-samples-btn').click(function () {
          if(confirm("Are you sure you wish to remove all samples from this assay?")) {
            samplesList.removeAll();
          }
          return false;
        });

        // Wizard steps
        var wizard = new Wizards.Wizard($j('#AddSamplesFromDataFileModal'));

        // When a datafile is selected, unlock and show step 2
        $j('#AddSamplesFromDataFileModal').on('click', '[data-role="seek-association-candidate"]', function () {
          wizard.step(2).unlock();
          wizard.gotoStep(2);
        });

        // When at least one sample is selected, unlock step 3
        var handleRowSelect = function ( e, dt, type, indexes ) {
          var selectedRows = samplesTable.rows({ selected: true });

          batchSamplesForm.selectedItems = [];
          selectedRows.every(function () {
            batchSamplesForm.selectedItems.push({
              id: this.data()[0],
              title: this.data()[1]
            });
          });

          if(selectedRows.count() > 0) {
            wizard.step(3).unlock();
          } else {
            wizard.step(3).lock();
          }
        };
        samplesTable.on('select', handleRowSelect);
        samplesTable.on('deselect', handleRowSelect);

        // On final step, show the confirm button
        wizard.step(3).onShow = function () {
          $j('#add-batch-sample-btn').show();
        };
        wizard.step(3).onHide = function () {
          $j('#add-batch-sample-btn').hide();
        };

        // Reset the wizard when the modal is closed
        $j('#AddSamplesFromDataFileModal').on('hide.bs.modal', function () {
          samplesTable.rows().deselect();
          wizard.reset();
        })
    </script>
<% end %>
