- hosts: [servers]
  become: true
  become_user: '{{user_var}}'
  vars_files:
    - group_vars/vars.yml
    - group_vars/sensitive_vars.yml

  environment: 
    PATH: '{{ruby_275_path}}:{{ ansible_env.PATH }}:{{rvm_path}}'

  tasks: 

########## Update and install dependencies
    - name: Update all packages to their latest version
      become: true
      become_user: root
      ansible.builtin.apt:
        name: "*"
        state: latest

    - name: Install a list of packages
      become: true
      become_user: root
      ansible.builtin.apt:
        pkg:
        - build-essential
        - cmake
        - git
        - imagemagick
        - libcurl4-gnutls-dev
        - libgmp-dev
        - libmagick++-dev
        - libmysqlclient-dev
        - libpq-dev
        - libreadline-dev
        - libreoffice
        - libssl-dev
        - libxml++2.6-dev
        - libxslt1-dev
        - mysql-server
        - nodejs
        - openjdk-8-jre
        - openjdk-11-jdk
        - openssh-server
        - poppler-utils
        - zip
        - autoconf
        - automake
        - bison
        - curl
        - gawk
        - libffi-dev
        - libgdbm-dev
        - libncurses5-dev
        - libsqlite3-dev
        - libyaml-dev
        - sqlite3
        - python3-pymysql

    - name: Correct java version selected
      become: true
      become_user: root
      community.general.alternatives:
        name: java
        path: /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java

########## Install rvm and ruby 2.7.5
    - name: Add repository to install rvm
      become: true
      become_user: root
      ansible.builtin.apt_repository:
        repo: ppa:rael-gc/rvm

    - name: Install rvm
      become: true
      become_user: root
      ansible.builtin.apt:
        pkg:
        - software-properties-common
        - rvm

    - name: Activate user rvm
      become: true
      become_user: root
      shell: >
        usermod -a -G rvm '{{user_var}}'
    
    - name: Install openssl for Ruby 2.7.5
      become: true
      become_user: root
      ansible.builtin.apt:
        pkg:
        - libssl-dev=1.1.1l-1ubuntu1.4
        force: yes

    - name: Reset connection  #To allow user changes to affect 'current login user'
      meta: reset_connection
    
    - name: Install Ruby 2.7.5
      shell: >
        rvm install "ruby-2.7.5"
        
    - name: Make Ruby 2.7.5 default
      shell: >
        rvm alias create default ruby-2.7.5 && 
        rvm --default use ruby-2.7.5
      
    - name: Generate docs
      shell: >
        rvm all do rvm docs generate
        
    - name: Install bundler
      shell: >
        gem install bundler

########## Clone and install SEEK

    - name: Clone SEEK git repo
      ansible.builtin.git:
        repo: 'https://github.com/seek4science/seek.git'
        dest: '{{git_dest}}/SEEK'
        version: 'v1.12.3'
        force: yes

    - name: Configure git
      shell: >
        git config --global --add safe.directory '{{git_dest}}/SEEK'
      run_once: true

    - name: Install SEEK Gems
      shell: >
        bundle install
      args:
        chdir: '{{git_dest}}/SEEK'

########## Configure database

    - name: Copy default database config
      ansible.builtin.copy:
        src: '{{git_dest}}/SEEK/config/database.default.yml'
        dest: '{{git_dest}}/SEEK/config/database.yml'
        remote_src: yes

    - name: Configure database user
      ansible.builtin.replace:
        path: '{{git_dest}}/SEEK/config/database.yml'
        regexp: 'mysqluser'
        replace: '{{sql_user}}'

    - name: Configure database password
      ansible.builtin.replace:
        path: '{{git_dest}}/SEEK/config/database.yml'
        regexp: 'mysqlpassword'
        replace: '{{sql_password}}'

    - name: Create database user
      become: true
      become_user: root
      mysql_user:
        name: '{{sql_user}}'
        password: '{{sql_password}}'
        priv: '*.*:ALL,GRANT'
        state: present
        login_unix_socket: /run/mysqld/mysqld.sock

########## Setup and launch

    - name: Rake db:setup
      shell: >
        bundle exec rake db:setup
      args:
        chdir: '{{git_dest}}/SEEK'

    # - name: Rails server
    #   shell: >
    #     bundle exec rails server
    #   args:
    #     chdir: '{{git_dest}}/SEEK'
